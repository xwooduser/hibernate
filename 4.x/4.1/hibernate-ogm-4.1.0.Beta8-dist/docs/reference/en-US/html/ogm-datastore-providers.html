<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 5. Datastores</title><link rel="stylesheet" href="css/hibernate.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="home" href="index.html" title="Hibernate OGM Reference Guide"/><link rel="up" href="index.html" title="Hibernate OGM Reference Guide"/><link rel="prev" href="ogm-configuration.html" title="Chapter 4. Configure and start Hibernate OGM"/><link rel="next" href="ogm-mapping.html" title="Chapter 6. Map your entities"/></head><body><p id="title"><a href="http://www.hibernate.org" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ogm-configuration.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ogm-mapping.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-datastore-providers"/>Chapter 5. Datastores</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan">5.1. Infinispan</a></span></dt><dd><dl><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan-configuration">5.1.1. Configure Infinispan</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan-storage">5.1.2. Manage data size</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan-clustering">5.1.3. Clustering: deploy multiple Infinispan nodes</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan-transactions">5.1.4. Transactions</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-infinispan-indexstorage">5.1.5. Storing a Lucene index in Infinispan</a></span></dt></dl></dd><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-ehcache">5.2. Ehcache</a></span></dt><dd><dl><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-ehcache-configuration">5.2.1. Configure Ehcache</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-ehcache-transactions">5.2.2. Transactions</a></span></dt></dl></dd><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-mongodb">5.3. MongoDB</a></span></dt><dd><dl><dt><span class="section"><a href="ogm-datastore-providers.html#_configuring_mongodb">5.3.1. Configuring MongoDB</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-mongodb-storage-principles">5.3.2. Storage principles</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#_transactions">5.3.3. Transactions</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-mongodb-queries">5.3.4. Queries</a></span></dt></dl></dd><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-neo4j">5.4. Neo4j</a></span></dt><dd><dl><dt><span class="section"><a href="ogm-datastore-providers.html#_how_to_add_neo4j_integration">5.4.1. How to add Neo4j integration</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#_configuring_neo4j">5.4.2. Configuring Neo4j</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-neo4j-storage-principles">5.4.3. Storage principles</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-neo4j-transactions">5.4.4. Transactions</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-neo4j-queries">5.4.5. Queries</a></span></dt></dl></dd><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-couchdb">5.5. CouchDB</a></span></dt><dd><dl><dt><span class="section"><a href="ogm-datastore-providers.html#_configuring_couchdb">5.5.1. Configuring CouchDB</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#ogm-couchdb-storage-principles">5.5.2. Storage principles</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#_transactions_2">5.5.3. Transactions</a></span></dt><dt><span class="section"><a href="ogm-datastore-providers.html#_queries">5.5.4. Queries</a></span></dt></dl></dd></dl></div><p>Currently Hibernate OGM supports the following datastores:</p><div class="itemizedlist"><ul><li>Map: stores data in an in-memory Java map to store data.
Use it only for unit tests.</li><li>Infinispan: stores data into <a class="ulink" href="http://infinispan.org/">Infinispan</a> (data grid)</li><li>Ehcache: stores data into <a class="ulink" href="http://ehcache.org/">Ehcache</a> (cache)</li><li>MongoDB: stores data into <a class="ulink" href="http://www.mongodb.org/">MongoDB</a> (document store)</li><li>Neo4j: stores data into <a class="ulink" href="http://www.neo4j.org/">Neo4j</a> (graph database)</li><li>CouchDB: stores data into <a class="ulink" href="https://couchdb.apache.org/">CouchDB</a> (document store)</li></ul></div><p>More are planned, if you are interested,
come talk to us (see <a class="xref" href="ogm-howtocontribute.html" title="Chapter 1. How to get help and contribute on Hibernate OGM">Chapter 1, <i>How to get help and contribute on Hibernate OGM</i></a>).</p><p>Hibernate OGM interacts with NoSQL datastores via two contracts:</p><div class="itemizedlist"><ul><li>a datastore provider which is responsible for
starting and stopping the connection(s) with the datastore
and prop up the datastore if needed</li><li>a grid dialect which is responsible for
converting an Hibernate OGM operation into a datastore specific operation</li></ul></div><p>The main thing you need to do is to configure which datastore provider you want to use.
This is done via the <code class="literal">hibernate.ogm.datastore.provider</code> option.
Possible values are</p><div class="itemizedlist"><ul><li>the fully qualified class name of a <code class="literal"><span class="classname">DatastoreProvider</span></code> implementation or</li><li>one preferably of the following shortcuts: <code class="literal">map</code> (only to be used for unit tests),
<code class="literal">infinispan</code>, <code class="literal">ehcache</code>, <code class="literal">mongodb</code>, <code class="literal">neo4j</code> or <code class="literal">couchdb</code></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants declared on <code class="literal">OgmProperties</code> to specify configuration properties
such as <code class="literal">hibernate.ogm.datastore.provider</code>.</p><p>In this case you also can specify the provider in form of a class object of a datastore provider type
or pass an instance of a datastore provider type:</p><pre xmlns="" class="JAVA"><!-- <br/> --><span class="java_type">Map</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;properties&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">HashMap</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;pass&nbsp;the&nbsp;type</span>
<!--  --><br/><span class="java_plain">properties</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">OgmProperties</span><span class="java_separator">.</span><span class="java_plain">DATASTORE_PROVIDER</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">MyDatastoreProvider</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;or&nbsp;an&nbsp;instance</span>
<!--  --><br/><span class="java_plain">properties</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">OgmProperties</span><span class="java_separator">.</span><span class="java_plain">DATASTORE_PROVIDER</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">MyDatastoreProvider</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">EntityManagerFactory</span><span class="java_plain">&nbsp;emf&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Persistence</span><span class="java_separator">.</span><span class="java_plain">createEntityManagerFactory</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;my-pu&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;properties&nbsp;</span><span class="java_separator">);</span></pre></div><p>You also need to add the relevant Hibernate OGM module in your classpath.
In maven that would look like:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ogm</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-ogm-infinispan</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">4.1.0.Beta8</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>The module names are
<code class="literal">hibernate-ogm-infinispan</code>, <code class="literal">hibernate-ogm-ehcache</code>, <code class="literal">hibernate-ogm-mongodb</code>, <code class="literal">hibernate-ogm-neo4j</code> and <code class="literal">hibernate-ogm-couchdb</code>.
The map datastore is included in the Hibernate OGM engine module.</p><p>By default, a datastore provider chooses the best grid dialect transparently
but you can manually override that setting
with the <code class="literal">hibernate.ogm.datastore.grid_dialect</code> option.
Use the fully qualified class name of the <code class="literal"><span class="classname">GridDialect</span></code> implementation.
Most users should ignore this setting entirely and live happy.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-infinispan"/>5.1. Infinispan</h2></div></div></div><p>Infinispan is an open source in-memory data grid focusing on high performance.
As a data grid, you can deploy it on multiple servers - referred to as nodes -
and connect to it as if it were a single storage engine:
it will cleverly distribute both the computation effort and the data storage.</p><p>It is trivial to setup on a single node, in your local JVM,
so you can easily try Hibernate OGM.
But Infinispan really shines in multiple node deployments:
you will need to configure some networking details
but nothing changes in terms of application behaviour,
while performance and data size can scale linearly.</p><p>From all its features we’ll only describe those relevant to Hibernate OGM;
for a complete description of all its capabilities and configuration options,
refer to the Infinispan project documentation at
<a class="ulink" href="http://infinispan.org">infinispan.org</a>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-infinispan-configuration"/>5.1.1. Configure Infinispan</h3></div></div></div><p>Two steps basically:</p><div class="itemizedlist"><ul><li>Add the dependencies to classpath</li><li><p>And then choose one of:</p><div class="itemizedlist"><ul><li>Use the default Infinispan configuration (no action needed)</li><li>Point to your own configuration resource name</li><li>Point to a <code class="literal"><span class="acronym">JNDI</span></code> name of an existing Infinispan instance</li></ul></div></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-infinispan-adddepencies"/>5.1.1.1. Adding Infinispan dependencies</h4></div></div></div><p>To add the dependencies via some Maven-definitions-using tool,
add the following module:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ogm</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-ogm-infinispan</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">4.1.0.Beta8</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>If you’re not using a dependency management tool,
copy all the dependencies from the distribution in the directories:</p><div class="itemizedlist"><ul><li><code class="literal">/lib/required</code></li><li><code class="literal">/lib/infinispan</code></li><li>Optionally - depending on your container - you might need some of the jars from <code class="literal">/lib/provided</code></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-infinispan-configuration-properties"/>5.1.1.2. Infinispan specific configuration properties</h4></div></div></div><p>The advanced configuration details of an Infinispan Cache
are defined in an Infinispan specific XML configuration file;
the Hibernate OGM properties are simple
and usually just point to this external resource.</p><p>To use the default configuration provided by Hibernate OGM -
which is a good starting point for new users - you don’t have to set any property.</p><div class="variablelist"><p class="title"><b>Infinispan datastore configuration properties</b></p><dl><dt><span class="term"><code class="literal">hibernate.ogm.datastore.provider</code></span></dt><dd>To use Infinispan as a datastore provider set it to <code class="literal">infinispan</code>.</dd><dt><span class="term"><code class="literal">hibernate.ogm.infinispan.cachemanager_jndi_name</code></span></dt><dd>If you have an Infinispan <code class="literal"><span class="classname">EmbeddedCacheManager</span></code>  registered in JNDI,
provide the JNDI name and Hibernate OGM will use this instance
instead of starting a new <code class="literal">CacheManager</code>.
This will ignore any further configuration properties
as Infinispan is assumed being already configured.</dd><dt><span class="term"><code class="literal">hibernate.ogm.infinispan.configuration_resource_name</code></span></dt><dd>Should point to the resource name of an Infinispan configuration file.
This is ignored in case <code class="literal"><span class="acronym">JNDI</span></code>  lookup is set.
Defaults to <code class="literal">org/hibernate/ogm/datastore/infinispan/default-config.xml</code>.</dd></dl></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code class="literal">InfinspanProperties</code>
when specifying the configuration properties listed above.
Common properties shared between stores are declared on <code class="literal">OgmProperties</code>.
To ease migration between stores, it is recommended to reference these constants directly from there.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_cache_names_used_by_hibernate_ogm"/>5.1.1.3. Cache names used by Hibernate OGM</h4></div></div></div><p>Hibernate OGM will not use a single Cache but three
and is going to use them for different purposes;
so that you can configure the Caches meant for each role separately.</p><div class="variablelist"><p class="title"><b>Infinispan cache names and purpose</b></p><dl><dt><span class="term"><code class="literal">ENTITIES</code></span></dt><dd>Is going to be used to store the main attributed of your entities.</dd><dt><span class="term"><code class="literal">ASSOCIATIONS</code></span></dt><dd>Stores the association information which maps to the relations between your entities.</dd><dt><span class="term"><code class="literal">IDENTIFIER_STORE</code></span></dt><dd>Contains internal metadata that Hibernate OGM needs
to provide sequences and auto-incremental numbers for primary key generation.</dd></dl></div><p>We’ll explain in the following paragraphs how you can take advantage of this
and which aspects of Infinispan you’re likely to want to reconfigure from their defaults.
All attributes and elements from Infinispan which we don’t mention are safe to ignore.
Refer to the <a class="ulink" href="https://docs.jboss.org/author/display/ISPN/User+Guide">Infinispan User Guide</a>
for the guru level performance tuning and customizations.</p><p>An Infinispan configuration file is an XML file complying with the Infinispan schema;
the basic structure is shown in the following example:</p><div class="example"><a id="d0e1636"/><p class="title"><b>Example 5.1. Simple structure of an infinispan xml configuration file</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">infinispan</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:infinispan:config:6.0&nbsp;http://www.infinispan.org/schemas/infinispan-config-6.0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:infinispan:config:6.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ENTITIES&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ASSOCIATIONS&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;IDENTIFIERS&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">infinispan</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>The <code class="literal">global</code> section contains elements which affect the whole instance;
mainly of interest for Hibernate OGM users is the <code class="literal">transport</code> element
in which we’ll set JGroups configuration overrides.</p><p>In the <code class="literal">namedCache</code> section (or in <code class="literal">default</code> if we want to affect all named caches)
we’ll likely want to configure clustering modes, eviction policies and <code class="literal">CacheStore</code>s.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-infinispan-storage"/>5.1.2. Manage data size</h3></div></div></div><p>In its default configuration Infinispan stores all data in the heap of the JVM;
in this barebone mode it is conceptually not very different than using a HashMap:
the size of the data should fit in the heap of your VM,
and stopping/killing/crashing your application will get all data lost
with no way to recover it.</p><p>To store data permanently (out of the JVM memory) a <code class="literal">CacheStore</code> should be enabled.
The <code class="literal">infinispan-core.jar</code> includes a simple implementation
able to store data in simple binary files, on any read/write mounted filesystem;
this is an easy starting point, but the real stuff is to be found
in the additional modules found in the Infinispan distribution.
Here you can find many more implementations to store your data in anything
from JDBC connected relational databases, other NoSQL engines,
to cloud storage services or other Infinispan clusters.
Finally, implementing a custom <code class="literal">CacheStore</code> is a trivial programming exercise.</p><p>To limit the memory consumption of the precious heap space,
you can activate a <code class="literal">passivation</code> or an <code class="literal">eviction</code> policy;
again there are several strategies to play with,
for now let’s just consider you’ll likely need one to avoid running out of memory
when storing too many entries in the bounded JVM memory space;
of course you don’t need to choose one while experimenting with limited data sizes:
enabling such a strategy doesn’t have any other impact
in the functionality of your Hibernate OGM application
(other than performance: entries stored in the Infinispan in-memory space
is accessed much quicker than from any CacheStore).</p><p>A <code class="literal">CacheStore</code> can be configured as write-through,
committing all changes to the <code class="literal">CacheStore</code> before returning (and in the same transaction)
or as write-behind.
A write-behind configuration is normally not encouraged in storage engines,
as a failure of the node implies some data might be lost
without receiving any notification about it,
but this problem is mitigated in Infinispan because of its capability
to combine CacheStore write-behind
with a synchronous replication to other Infinispan nodes.</p><div class="example"><a id="d0e1692"/><p class="title"><b>Example 5.2. Enabling a FileCacheStore and eviction</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ENTITIES&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">eviction</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">strategy</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;LIRS&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">maxEntries</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2000&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">loaders</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">passivation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">shared</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">loader</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">class</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.infinispan.loaders.file.FileCacheStore&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">fetchPersistentState</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">purgeOnStartup</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;location&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;/var/hibernate-ogm/myapp/entities-data&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">loader</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">loaders</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>In this example we enabled both <code class="literal">eviction</code> and a <code class="literal">CacheStore</code> (the <code class="literal">loader</code> element).
<code class="literal">LIRS</code> is one of the choices we have for eviction strategies.
Here it is configured to keep (approximately) 2000 entries in live memory
and evict the remaining as a memory usage control strategy.</p><p>The <code class="literal">CacheStore</code> is enabling <code class="literal">passivation</code>,
which means that the entries which are evicted are stored on the filesystem.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>You could configure an eviction strategy while not configuring a passivating CacheStore!
That is a valid configuration for Infinispan but will have the evictor permanently remove entries.
Hibernate OGM will break in such a configuration.</p></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Currently with Infinispan 5.1,
the <code class="literal"><span class="classname">FileCacheStore</span></code> is neither very fast nor very efficient:
we picked it for ease of setup.
For a production system it’s worth looking at the large collection
of high performance and cloud friendly cachestores
provided by the Infinispan distribution.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-infinispan-clustering"/>5.1.3. Clustering: deploy multiple Infinispan nodes</h3></div></div></div><p>The best thing about Infinispan is that all nodes are treated equally
and it requires almost no beforehand capacity planning:
to add more nodes to the cluster you just have to start new JVMs,
on the same or different physical server,
having your same Infinispan configuration and your same application.</p><p>Infinispan supports several clustering <span class="emphasis"><em>cache modes</em></span>;
each mode provides the same API and functionality
but with different performance, scalability and availability options:</p><div class="variablelist"><p class="title"><b>Infinispan cache modes</b></p><dl><dt><span class="term">local</span></dt><dd>Useful for a single VM: networking stack is disabled</dd><dt><span class="term">replication</span></dt><dd>All data is replicated to each node;
each node contains a full copy of all entries.
Consequentially reads are faster but writes don’t scale as well.
Not suited for very large datasets.</dd><dt><span class="term">distribution</span></dt><dd>Each entry is distributed on multiple nodes for redundancy and failure recovery,
but not to all the nodes.
Provides linear scalability for both write and read operations.
distribution is the default mode.</dd></dl></div><p>To use the <code class="literal">replication</code> or <code class="literal">distribution</code> cache modes
Infinispan will use JGroups to discover and connect to the other nodes.</p><p>In the default configuration,
JGroups will attempt to autodetect peer nodes using a multicast socket;
this works out of the box in the most network environments
but will require some extra configuration in cloud environments
(which often block multicast packets) or in case of strict firewalls.
See the <a class="ulink" href="http://www.jgroups.org/manual/html_single/">JGroups reference documentation</a>,
specifically look for <span class="emphasis"><em>Discovery Protocols</em></span> to customize the detection of peer nodes.</p><p>Nowadays, the <code class="literal"><span class="acronym">JVM</span></code> defaults to use <code class="literal"><span class="acronym">IPv6</span></code> network stack;
this will work fine with JGroups, but only if you configured <code class="literal"><span class="acronym">IPv6</span></code> correctly.
It is often useful to force the <code class="literal"><span class="acronym">JVM</span></code> to use <code class="literal"><span class="acronym">IPv4</span></code>.</p><p>It is also useful to let JGroups know which networking interface you want to use;
especially if you have multiple interfaces it might not guess correctly.</p><div class="example"><a id="d0e1800"/><p class="title"><b>Example 5.3. JVM properties to set for clustering</b></p><div class="example-contents"><pre class="screen">#192.168.122.1 is an example IPv4 address
-Djava.net.preferIPv4Stack=true -Djgroups.bind_addr=192.168.122.1</pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>You don’t need to use <code class="literal"><span class="acronym">IPv4</span></code>: JGroups is compatible with <code class="literal"><span class="acronym">IPv6</span></code>
provided you have routing properly configured and valid addresses assigned.</p><p>The <code class="literal">jgroups.bind_addr</code> needs to match a placeholder name
in your JGroups configuration in case you don’t use the default one.</p></div><p>The default configuration uses <code class="literal">distribution</code> as cache mode
and uses the <code class="literal">jgroups-tcp.xml</code> configuration for JGroups,
which is contained in the Infinispan jar
as the default configuration for Infinispan users.
Let’s see how to reconfigure this:</p><div class="example"><a id="d0e1829"/><p class="title"><b>Example 5.4. Reconfiguring cache mode and override JGroups configuration</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">infinispan</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:infinispan:config:6.0&nbsp;http://www.infinispan.org/schemas/infinispan-config-6.0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:infinispan:config:6.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">transport</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">clusterName</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;HibernateOGM-Infinispan-cluster&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;configurationFile&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;my-jgroups-conf.xml&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">transport</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">global</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">clustering</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">mode</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;distribution&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Cache&nbsp;to&nbsp;store&nbsp;the&nbsp;OGM&nbsp;entities&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ENTITIES&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Cache&nbsp;to&nbsp;store&nbsp;the&nbsp;relations&nbsp;across&nbsp;entities&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ASSOCIATIONS&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Cache&nbsp;to&nbsp;store&nbsp;identifiers&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">namedCache</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;IDENTIFIERS&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Override&nbsp;the&nbsp;cache&nbsp;mode:&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">clustering</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">mode</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;replication&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">namedCache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">infinispan</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>In the example above we specify a custom JGroups configuration file
and set the cache mode for the default cache to <code class="literal">distribution</code>;
this is going to be inherited by the <code class="literal">ENTITIES</code> and the <code class="literal">ASSOCIATIONS</code> caches.
But for <code class="literal">IDENTIFIERS</code> we have chosen (for the sake of this example) to use <code class="literal">replication</code>.</p><p>Now that you have clustering configured, start the service on multiple nodes.
Each node will need the same configuration and jars.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>We have just shown how to override the clustering mode
and the networking stack for the sake of completeness, but you don’t have to!</p><p>Start with the default configuration and see if that fits you.
You can fine tune these setting when you are closer to going in production.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-infinispan-transactions"/>5.1.4. Transactions</h3></div></div></div><p>Infinispan supports transactions and integrates with any standard JTA <code class="literal">TransactionManager</code>;
this is a great advantage for JPA users as it allows to experience a <span class="emphasis"><em>similar</em></span> behaviour
to the one we are used to when we work with RDBMS databases.</p><p>If you’re having Hibernate OGM start and manage Infinispan,
you can skip this as it will inject the same <code class="literal"><span class="classname">TransactionManager</span></code> instance
which you already have set up in the Hibernate / JPA configuration.</p><p>If you are providing an already started Infinispan CacheManager instance
by using the <code class="literal"><span class="acronym">JNDI</span></code> lookup approach,
then you have to make sure the CacheManager is using the same <code class="literal"><span class="classname">TransactionManager</span></code>
as Hibernate:</p><div class="example"><a id="d0e1885"/><p class="title"><b>Example 5.5. Configuring a JBoss Standalone TransactionManager lookup</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">transaction</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">transactionMode</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;TRANSACTIONAL&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">transactionManagerLookupClass</span><span class="xml_tag_symbols">=</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_value">&quot;org.infinispan.transaction.lookup.JBossStandaloneJTAManagerLookup&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">default</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div></div><br class="example-break"/><p>Infinispan supports different transaction modes like <code class="literal">PESSIMISTIC</code> and <code class="literal">OPTIMISTIC</code>,
supports <code class="literal"><span class="acronym">XA</span></code> recovery and provides many more configuration options;
see the <a class="ulink" href="https://docs.jboss.org/author/display/ISPN/User+Guide">Infinispan User Guide</a>
for more advanced configuration options.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-infinispan-indexstorage"/>5.1.5. Storing a Lucene index in Infinispan</h3></div></div></div><p>Hibernate Search, which can be used for advanced query capabilities (see <a class="xref" href="ogm-query.html" title="Chapter 7. Query your entities">Chapter 7, <i>Query your entities</i></a>),
needs some place to store the indexes for its embedded <code class="literal">Apache Lucene</code> engine.</p><p>A common place to store these indexes is the filesystem
which is the default for Hibernate Search;
however if your goal is to scale your NoSQL engine on multiple nodes
you need to share this index.
Network sharing filesystems are a possibility but we don’t recommended that.
Often the best option is to store the index
in whatever NoSQL database you are using (or a different dedicated one).</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You might find this section useful even if you don’t intend to store your data in Infinispan.</p></div><p>The Infinispan project provides an adaptor to plug into Apache Lucene,
so that it writes the indexes in Infinispan and searches data in it.
Since Infinispan can be used as an application cache to other NoSQL storage engines
by using a CacheStore (see <a class="xref" href="ogm-datastore-providers.html#ogm-infinispan-storage" title="5.1.2. Manage data size">Section 5.1.2, “Manage data size”</a>)
you can use this adaptor to store the Lucene indexes
in any NoSQL store supported by Infinispan:</p><div class="itemizedlist"><ul><li>Cassandra</li><li>Filesystem (but locked correctly at the Infinispan level)</li><li>MongoDB</li><li>HBase</li><li>JDBC databases</li><li>JDBM</li><li>BDBJE</li><li>A secondary (independent) Infinispan grid</li><li>Any Cloud storage service
<a class="ulink" href="http://www.jclouds.org/documentation/reference/supported-providers/">supported by JClouds</a></li></ul></div><p>How to configure it? Here is a simple cheat sheet to get you started with this type of setup:</p><div class="itemizedlist"><ul><li>Add <code class="literal">org.hibernate:hibernate-search-infinispan:4.5.1.Final</code> to your dependencies</li><li><p>set these configuration properties:</p><div class="itemizedlist"><ul><li><code class="literal">hibernate.search.default.directory_provider = infinispan</code></li><li><code class="literal">hibernate.search.default.exclusive_index_use = false</code></li><li><code class="literal">hibernate.search.infinispan.configuration_resourcename =</code> [infinispan configuration filename]</li></ul></div></li></ul></div><p>The referenced Infinispan configuration should define a <code class="literal"><span class="classname">CacheStore</span></code>
to load/store the index in the NoSQL engine of choice.
It should also define three cache names:</p><div class="table"><a id="d0e1986"/><p class="title"><b>Table 5.1. Infinispan caches used to store indexes</b></p><div class="table-contents"><table summary="Infinispan caches used to store indexes" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="left" valign="top">Cache name</th><th align="left" valign="top">Description</th><th align="left" valign="top">Suggested cluster mode</th></tr></thead><tbody><tr><td align="left" valign="top"><p>LuceneIndexesLocking</p></td><td align="left" valign="top"><p>Transfers locking information. Does not need a cache
            store.</p></td><td align="left" valign="top"><p>replication</p></td></tr><tr><td align="left" valign="top"><p>LuceneIndexesData</p></td><td align="left" valign="top"><p>Contains the bulk of Lucene data. Needs a cache
            store.</p></td><td align="left" valign="top"><p>distribution + L1</p></td></tr><tr><td align="left" valign="top"><p>LuceneIndexesMetadata</p></td><td align="left" valign="top"><p>Stores metadata on the index segments. Needs a cache
            store.</p></td><td align="left" valign="top"><p>replication</p></td></tr></tbody></table></div></div><br class="table-break"/><p>This configuration is not going to scale well on write operations:
to do that you should read about the master/slave and sharding options in Hibernate Search.
The complete explanation and configuration options can be found in the
<a class="ulink" href="http://docs.jboss.org/hibernate/search/4.2/reference/en-US/html_single/#infinispan-directories">Hibernate Search Reference Guide</a></p><p>Some NoSQL support storage of Lucene indexes directly,
in which case you might skip the Infinispan Lucene integration
by implementing a custom <code class="literal"><span class="classname">DirectoryProvider</span></code> for Hibernate Search.
You’re very welcome to share the code
and have it merged in Hibernate Search for others to use, inspect, improve and maintain.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-ehcache"/>5.2. Ehcache</h2></div></div></div><p>When combined with Hibernate ORM, Ehcache is commonly used as a 2nd level cache,
so caching data which is stored in a relational database.
When used with Hibernate OGM it is not "just a cache"
but is the main storage engine for your data.</p><p>This is not the reference manual for Ehcache itself:
we’re going to list only how Hibernate OGM should be configured to use Ehcache;
for all the tuning and advanced options please refer to the
<a class="ulink" href="http://www.ehcache.org/documentation">Ehcache Documentation</a>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-ehcache-configuration"/>5.2.1. Configure Ehcache</h3></div></div></div><p>Two steps:</p><div class="itemizedlist"><ul><li>Add the dependencies to classpath</li><li><p>And then choose one of:</p><div class="itemizedlist"><ul><li>Use the default Ehcache configuration (no action needed)</li><li>Point to your own configuration resource name</li></ul></div></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-ehcache-adddepencies"/>5.2.1.1. Adding Ehcache dependencies</h4></div></div></div><p>To add the dependencies via some Maven-definitions-using tool,
add the following module:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ogm</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-ogm-ehcache</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">4.1.0.Beta8</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>If you’re not using a dependency management tool,
copy all the dependencies from the distribution in the directories:</p><div class="itemizedlist"><ul><li><code class="literal">/lib/required</code></li><li><code class="literal">/lib/ehcache</code></li><li>Optionally - depending on your container -
you might need some of the jars from <code class="literal">/lib/provided</code></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-ehcache-configuration-properties"/>5.2.1.2. Ehcache specific configuration properties</h4></div></div></div><p>Hibernate OGM expects you to define an Ehcache configuration
in its own configuration resource;
all what we need to set it the resource name.</p><p>To use the default configuration provided by Hibernate OGM -
which is a good starting point for new users - you don’t have to set any property.</p><div class="variablelist"><p class="title"><b>Ehcache datastore configuration properties</b></p><dl><dt><span class="term">hibernate.ogm.datastore.provider</span></dt><dd>To use Ehcache as a datastore provider set it to <code class="literal">ehcache</code>.</dd><dt><span class="term">hibernate.ogm.ehcache.configuration_resource_name</span></dt><dd>Should point to the resource name of an Ehcache configuration file.
Defaults to <code class="literal">org/hibernate/ogm/datastore/ehcache/default-ehcache.xml</code>.</dd></dl></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code class="literal">EhcacheProperties</code>
when specifying the configuration properties listed above.
Common properties shared between stores are declared on <code class="literal">OgmProperties</code>.
To ease migration between stores, it is recommended to reference these constants directly from there.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-ehcache-transactions"/>5.2.2. Transactions</h3></div></div></div><p>While Ehcache technically supports transactions,
Hibernate OGM is currently unable to use them. Careful!</p><p>If you need this feature, it should be easy to implement:
contributions welcome! See
<a class="ulink" href="https://hibernate.onjira.com/browse/OGM-243">JIRA OGM-243</a>.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-mongodb"/>5.3. MongoDB</h2></div></div></div><p><a class="ulink" href="http://www.mongodb.org">MongoDB</a> is a document oriented datastore
written in C++ with strong emphasis on ease of use.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_mongodb"/>5.3.1. Configuring MongoDB</h3></div></div></div><p>This implementation is based upon the MongoDB Java driver.
The currently supported version is 2.12.4.</p><p>The following properties are available to configure MongoDB support:</p><div class="variablelist"><p class="title"><b>MongoDB datastore configuration properties</b></p><dl><dt><span class="term">hibernate.ogm.datastore.provider</span></dt><dd>To use MongoDB as a datastore provider, this property must be set to <code class="literal">mongodb</code></dd><dt><span class="term">hibernate.ogm.option.configurator</span></dt><dd>The fully-qualified class name or an instance of a programmatic option configurator (see <a class="xref" href="ogm-datastore-providers.html#ogm-mongodb-programmatic-configuration" title="5.3.1.2. Programmatic configuration">Section 5.3.1.2, “Programmatic configuration”</a>)</dd><dt><span class="term">hibernate.ogm.datastore.host</span></dt><dd>The hostname of the MongoDB instance. The default value is <code class="literal">127.0.0.1</code>.</dd><dt><span class="term">hibernate.ogm.datastore.port</span></dt><dd>The port used by the MongoDB instance. The default value is <code class="literal">27017</code>.</dd><dt><span class="term">hibernate.ogm.datastore.database</span></dt><dd>The database to connect to. This property has no default value.</dd><dt><span class="term">hibernate.ogm.datastore.username</span></dt><dd>The username used when connecting to the MongoDB server.
This property has no default value.</dd><dt><span class="term">hibernate.ogm.datastore.password</span></dt><dd>The password used to connect to the MongoDB server.
This property has no default value.
This property is ignored if the username isn’t specified.</dd><dt><span class="term">hibernate.ogm.mongodb.connection_timeout</span></dt><dd>Defines the timeout used by the driver
when the connection to the MongoDB instance is initiated.
This configuration is expressed in milliseconds.
The default value is <code class="literal">5000</code>.</dd><dt><span class="term">hibernate.ogm.datastore.document.association_storage</span></dt><dd>Defines the way OGM stores association information in MongoDB.
The following two strategies exist (values of the <code class="literal">org.hibernate.ogm.datastore.document.options.AssociationStorageType</code> enum):
<code class="literal">IN_ENTITY</code> (store association information within the entity) and
<code class="literal">ASSOCIATION_DOCUMENT</code> (store association information in a dedicated document per association).
<code class="literal">IN_ENTITY</code> is the default and recommended option
unless the association navigation data is much bigger than the core of the document and leads to performance degradation.</dd><dt><span class="term">hibernate.ogm.mongodb.association_document_storage</span></dt><dd><p>Defines how to store assocation documents (applies only if the <code class="literal">ASSOCIATION_DOCUMENT</code>
association storage strategy is used).
Possible strategies are (values of the <code class="literal">org.hibernate.ogm.datastore.mongodb.options.AssociationDocumentType</code> enum):</p><div class="itemizedlist"><ul><li><code class="literal">GLOBAL_COLLECTION</code> (default): stores the association information in a unique MongoDB collection for all associations</li><li><code class="literal">COLLECTION_PER_ASSOCIATION</code> stores the association in a dedicated MongoDB collection per association</li></ul></div></dd><dt><span class="term">hibernate.ogm.mongodb.write_concern</span></dt><dd>Defines the write concern setting to be applied when issuing writes against the MongoDB datastore.
Possible settings are (values of the <code class="literal">WriteConcernType</code> enum):
<code class="literal">ERRORS_IGNORED</code>, <code class="literal">ACKNOWLEDGED</code>, <code class="literal">UNACKNOWLEDGED</code>, <code class="literal">FSYNCED</code>, <code class="literal">JOURNALED</code>, <code class="literal">REPLICA_ACKNOWLEDGED</code>, <code class="literal">MAJORITY</code> and <code class="literal">CUSTOM</code>.
When set to <code class="literal">CUSTOM</code>, a custom <code class="literal">WriteConcern</code> implementation type has to be specified.</dd><dt><span class="term">hibernate.ogm.mongodb.write_concern_type</span></dt><dd>Specifies a custom <code class="literal">WriteConcern</code> implementation type (fully-qualified name, class object or instance).
This is useful in cases where the pre-defined configurations are not sufficient,
e.g. if you want to ensure that writes are propagated to a specific number of replicas or given "tag set".
Only takes effect if <code class="literal">hibernate.ogm.mongodb.write_concern</code> is set to <code class="literal">CUSTOM</code>.</dd><dt><span class="term">hibernate.ogm.mongodb.read_preference</span></dt><dd>Specifies the <code class="literal">ReadPreference</code> to be applied when issuing reads against the MongoDB datastore.
Possible settings are (values of the <code class="literal">ReadPreferenceType</code> enum):
<code class="literal">PRIMARY</code>, <code class="literal">PRIMARY_PREFERRED</code>, <code class="literal">SECONDARY</code>, <code class="literal">SECONDARY_PREFERRED</code> and <code class="literal">NEAREST</code>.
It’s currently not possible to plug in custom read preference types.
If you’re interested in such a feature, please let us know.</dd></dl></div><p>For more information, please refer to the
<a class="ulink" href="http://api.mongodb.org/java/current/com/mongodb/WriteConcern.html">official documentation</a>.
This option is case insensitive and the default value is <code class="literal">ACKNOWLEDGED</code>.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code class="literal">MongoDBProperties</code>
when specifying the configuration properties listed above.
Common properties shared between (document) stores are declared on <code class="literal">OgmProperties</code> and <code class="literal">DocumentStoreProperties</code>, respectively.
To ease migration between stores, it is recommended to reference these constants directly from there.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-mongodb-annotation-configuration"/>5.3.1.1. Annotation based configuration</h4></div></div></div><p>Hibernate OGM allows to configure store-specific options via Java annotations.
When working with the MongoDB backend, you can specify the following settings:</p><div class="itemizedlist"><ul><li>the write concern for entities and associations using the <code class="literal">@WriteConcern</code> annotation</li><li>the read preference for entities and associations using the <code class="literal">@ReadPreference</code> annotation</li><li>a strategy for storing associations using the <code class="literal">@AssociationStorage</code> and <code class="literal">@AssociationDocumentStorage</code> annotations
(refer to <a class="xref" href="ogm-datastore-providers.html#ogm-mongodb-storage-principles" title="5.3.2. Storage principles">Section 5.3.2, “Storage principles”</a> to learn more about these options).</li></ul></div><p>The following shows an example:</p><div class="example"><a id="d0e2392"/><p class="title"><b>Example 5.6. Configuring the association storage strategy using annotations</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">WriteConcern</span><span class="java_separator">(</span><span class="java_type">WriteConcernType</span><span class="java_separator">.</span><span class="java_plain">JOURNALED</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">ReadPreference</span><span class="java_separator">(</span><span class="java_type">ReadPreferenceType</span><span class="java_separator">.</span><span class="java_plain">PRIMARY_PREFERRED</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">AssociationStorage</span><span class="java_separator">(</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">AssociationDocumentStorage</span><span class="java_separator">(</span><span class="java_type">AssociationDocumentType</span><span class="java_separator">.</span><span class="java_plain">COLLECTION_PER_ASSOCIATION</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Zoo</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Animal</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;animals</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;employees</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">AssociationStorage</span><span class="java_separator">(</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">IN_ENTITY</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;visitors</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The <code class="literal">@WriteConcern</code> annotation on the entity level expresses that all writes should be done using the <code class="literal">JOURNALED</code> setting.
Similarly, the <code class="literal">@ReadPreference</code> annotation advices the engine to preferably read that entity from the primary node if possible.
The other two annotations on the type-level specify that all associations of the <code class="literal">Zoo</code>
class should be stored in separate assocation documents, using a dedicated collection per association.
This setting applies to the <code class="literal">animals</code> and <code class="literal">employees</code> associations.
Only the elements of the <code class="literal">visitors</code> association will be stored in the document of the corresponding <code class="literal">Zoo</code> entity
as per the configuration of that specific property which takes precedence over the entity-level configuration.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-mongodb-programmatic-configuration"/>5.3.1.2. Programmatic configuration</h4></div></div></div><p>In addition to the annotation mechanism,
Hibernate OGM also provides a programmatic API for applying store-specific configuration options.
This can be useful if you can’t modify certain entity types or
don’t want to add store-specific configuration annotations to them.
The API allows set options in a type-safe fashion on the global, entity and property levels.</p><p>When working with MongoDB, you can currently configure the following options using the API:</p><div class="itemizedlist"><ul><li>write concern</li><li>read preference</li><li>association storage strategy</li><li>association document storage strategy</li></ul></div><p>To set these options via the API, you need to create an <code class="literal">OptionConfigurator</code> implementation
as shown in the following example:</p><div class="example"><a id="d0e2448"/><p class="title"><b>Example 5.7. Example of an option configurator</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">MyOptionConfigurator</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">OptionConfigurator</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;configure</span><span class="java_separator">(</span><span class="java_type">Configurable</span><span class="java_plain">&nbsp;configurable</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configurable</span><span class="java_separator">.</span><span class="java_plain">configureOptionsFor</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">MongoDB</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">writeConcern</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">WriteConcernType</span><span class="java_separator">.</span><span class="java_plain">REPLICA_ACKNOWLEDGED&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">readPreference</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">ReadPreferenceType</span><span class="java_separator">.</span><span class="java_plain">NEAREST&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Zoo</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationDocumentStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationDocumentType</span><span class="java_separator">.</span><span class="java_plain">COLLECTION_PER_ASSOCIATION&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">property</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;animals&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ElementType</span><span class="java_separator">.</span><span class="java_plain">FIELD&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">IN_ENTITY&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Animal</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">writeConcern</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">RequiringReplicaCountOf</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">3</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The call to <code class="literal">configureOptionsFor()</code>, passing the store-specific identifier type <code class="literal">MongoDB</code>,
provides the entry point into the API. Following the fluent API pattern, you then can configure
global options (<code class="literal">writeConcern()</code>, <code class="literal">readPreference()</code>) and navigate to single entities or properties to apply options
specific to these (<code class="literal">associationStorage()</code> etc.).
The call to <code class="literal">writeConcern()</code>  for the <code class="literal">Animal</code>  entity shows how a specific write concern type can be used.
Here <code class="literal">RequiringReplicaCountOf</code> is a custom implementation of <code class="literal">WriteConcern</code> which ensures
that writes are propagated to a given number of replicas before a write is acknowledged.</p><p>Options given on the property level precede entity-level options. So e.g. the <code class="literal">animals</code> association of the <code class="literal">Zoo</code>
class would be stored using the in-entity strategy, while all other associations of the <code class="literal">Zoo</code> entity would
be stored using separate association documents.</p><p>Similarly, entity-level options take precedence over options given on the global level.
Global-level options specified via the API complement the settings given via configuration properties.
In case a setting is given via a configuration property and the API at the same time,
the latter takes precedence.</p><p>Note that for a given level (property, entity, global),
an option set via annotations is overridden by the same option set programmatically.
This allows you to change settings in a more flexible way if required.</p><p>To register an option configurator, specify its class name using the <code class="literal">hibernate.ogm.option.configurator</code> property.
When bootstrapping a session factory or entity manager factory programmatically,
you also can pass in an <code class="literal">OptionConfigurator</code> instance or the class object representing the configurator type.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-mongodb-storage-principles"/>5.3.2. Storage principles</h3></div></div></div><p>Hibernate OGM tries to make the mapping to the underlying datastore as natural as possible
so that third party applications not using Hibernate OGM can still read
and update the same datastore.
We worked particularly hard on the MongoDB model
to offer various classic mappings between your object model
and the MongoDB documents.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_entities"/>5.3.2.1. Entities</h4></div></div></div><p>Entities are stored as MongoDB documents and not as BLOBs
which means each entity property will be translated into a document field.
You can use the name property of the <code class="literal"><span class="classname">@Table</span></code> and <code class="literal"><span class="classname">@Column</span></code> annotations
to rename the collections and the document’s fields if you need to.</p><p>Note that embedded objects are mapped as nested documents.</p><div class="example"><a id="d0e2525"/><p class="title"><b>Example 5.8. Example of an entity with an embedded object</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">News</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;title</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;desc&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Embedded</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsPaper</span><span class="java_plain">&nbsp;paper</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Embeddable</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsPaper</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;owner</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" : "1234-5678-0123-4567",
    "title": "On the merits of NoSQL",
    "desc": "This paper discuss why NoSQL will save the world for good",
    "paper": {
        "name": "NoSQL journal of prophecies",
        "owner": "Delphy"
    }
}</pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_identifiers"/>5.3.2.1.1. Identifiers</h5></div></div></div><p>The <code class="literal">_id</code> field of a MongoDB document is directly used
to store the identifier columns mapped in the entities.
You can use simple identifiers (e.g. of type <code class="literal">long</code> with a table-based id generator or of type <code class="literal">String</code> with a GUID generator)
as well as embedded identifiers.</p><p>Generally, it is recommended though to work with MongoDB’s object id data type.
This will facilitate the integration with other applications possibly expecting that common MongoDB id type.
To do so, you have two options:</p><div class="itemizedlist"><ul><li>Define your id property as <code class="literal">String</code> and annotate it with <code class="literal">@Type(type="objectid")</code></li><li>Define your id property as <code class="literal">org.bson.types.ObjectId</code></li></ul></div><p>In both cases the id will be stored as native <code class="literal">ObjectId</code> in the datastore.</p><p>You can assign id values yourself or (preferably) take advantage of the <code class="literal">IDENTITY</code> generation strategy
which will automatically assign an id during insert. The following shows an example:</p><div class="example"><a id="d0e2572"/><p class="title"><b>Example 5.9. Mapping id as object id in MongoDB</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">News</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">GeneratedValue</span><span class="java_separator">(</span><span class="java_plain">strategy&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">GenerationType</span><span class="java_separator">.</span><span class="java_plain">IDENTITY</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Type</span><span class="java_separator">(</span><span class="java_plain">type&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;objectid&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;title</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" : ObjectId("5425448830048b67064d40b1"),
    "title" : "Exciting News"
}</pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>You also can use <code class="literal">GenerationType.AUTO</code> to store ids as object id in MongoDB.
This requires though the property <code class="literal">hibernate.id.new_generator_mappings</code> to be set to <code class="literal">false</code>.</p></div><p>Embedded identifiers are stored as embedded document within the <code class="literal">_id</code> field.
Hibernate OGM will convert the <code class="literal">@Id</code> property into a <code class="literal">_id</code> document field
so you can name the entity id like you want it will always be stored into <code class="literal">_id</code>
(the recommended approach in MongoDB).
That means in particular that MongoDB will automatically index your _id fields.
Let’s look at an example:</p><div class="example"><a id="d0e2605"/><p class="title"><b>Example 5.10. Example of an entity using Embedded id</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">News</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EmbeddedId</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsID</span><span class="java_plain">&nbsp;newsId</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Embeddable</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsID</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;title</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;author</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" :{
        "title": "How does Hibernate OGM MongoDB work?",
        "author": "Guillaume"
    }
}</pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_associations"/>5.3.2.2. Associations</h4></div></div></div><p>Hibernate OGM MongoDB proposes three strategies to store navigation information for associations.
To switch between these strategies,
either use the <code class="literal">@AssocationStorage</code> and <code class="literal">@AssociationDocumentStorage</code> annotations (see <a class="xref" href="ogm-datastore-providers.html#ogm-mongodb-annotation-configuration" title="5.3.1.1. Annotation based configuration">Section 5.3.1.1, “Annotation based configuration”</a>),
the API for programmatic configuration (see <a class="xref" href="ogm-datastore-providers.html#ogm-mongodb-programmatic-configuration" title="5.3.1.2. Programmatic configuration">Section 5.3.1.2, “Programmatic configuration”</a>) or
specify a default strategy via the <code class="literal">hibernate.ogm.datastore.document.association_storage</code> and
<code class="literal">hibernate.ogm.mongodb.association_document_storage</code> configuration properties.</p><p>The three possible strategies are:</p><div class="itemizedlist"><ul><li>IN_ENTITY (default)</li><li>ASSOCIATION_DOCUMENT, using a global collection for all associations</li><li>ASSOCIATION_DOCUMENT, using a dedicated collection for each association</li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_in_entity_strategy"/>5.3.2.2.1. In Entity strategy</h5></div></div></div><p>In this strategy, Hibernate OGM directly stores the id(s)
of the other side of the association
into a field or an embedded document
depending if the mapping concerns a single object or a collection.
The field that stores the relationship information is named like the entity property.</p><div class="example"><a id="d0e2650"/><p class="title"><b>Example 5.11. Java entity</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">AccountOwner</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">BankAccount</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bankAccounts</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><div class="example"><a id="d0e2655"/><p class="title"><b>Example 5.12. JSON representation</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" : "owner0001",
    "bankAccounts" : [
        "accountABC",
        "accountXYZ"
    ]
}</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_global_collection_strategy"/>5.3.2.2.2. Global collection strategy</h5></div></div></div><p>With this strategy, Hibernate OGM creates a single collection
in which it will store all navigation information for all associations.
Each document of this collection is structure in 2 parts.
The first is the <code class="literal">_id</code> field which contains the identifier information
of the association owner and the name of the association table.
The second part is the <code class="literal">rows</code> field which stores (into an embedded collection) all ids
that the current instance is related to.</p><div class="example"><a id="d0e2671"/><p class="title"><b>Example 5.13. Unidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id": {
        "owners_id": "owner0001",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [
        "accountABC",
        "accountXYZ"
    ]
}</pre></div></div><br class="example-break"/><p>For a bidirectional relationship, another document is created where ids are reversed.
Don’t worry, Hibernate OGM takes care of keeping them in sync:</p><div class="example"><a id="d0e2678"/><p class="title"><b>Example 5.14. Bidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id": {
        "owners_id": "owner0001",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [
        "accountABC",
        "accountXYZ"
        ]
}
{
    "_id": {
        "bankAccounts_id": "accountXYZ",
        "table": "AccountOwner_BankAccount"
    },
    "rows": [
        "owner0001"
    ]
}</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_one_collection_per_association_strategy"/>5.3.2.2.3. One collection per association strategy</h5></div></div></div><p>In this strategy, Hibernate OGM creates a MongoDB collection per association
in which it will store all navigation information for that particular association.
This is the strategy closest to the relational model.
If an entity A is related to B and C, 2 collections will be created.
The name of this collection is made of the association table concatenated with <code class="literal">associations_</code>.
For example, if the <code class="literal"><span class="classname">BankAccount</span></code> and <code class="literal"><span class="classname">Owner</span></code> are related,
the collection used to store will be named <code class="literal">associations_Owner_BankAccount</code>.
The prefix is useful to quickly identify the association collections from the entity collections.
Each document of an association collection has the following structure:</p><div class="itemizedlist"><ul><li><code class="literal">_id</code> contains the id of the owner of relationship</li><li><code class="literal">rows</code> contains all the id of the related entities</li></ul></div><div class="example"><a id="d0e2713"/><p class="title"><b>Example 5.15. Unidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" : { "owners_id" : "owner0001" },
    "rows" : [
        "accountABC",
        "accountXYZ"
    ]
}</pre></div></div><br class="example-break"/><div class="example"><a id="d0e2718"/><p class="title"><b>Example 5.16. Bidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id" : { "owners_id" : "owner0001" },
    "rows" : [
        "accountABC",
        "accountXYZ"
    ]
}
{
    "_id" : { "bankAccounts_id" : "accountXYZ" },
    "rows" : [
        "owner0001"
    ]
}</pre></div></div><br class="example-break"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_transactions"/>5.3.3. Transactions</h3></div></div></div><p>MongoDB does not support transactions.
Only changes applied to the same document are done atomically.
A change applied to more than one document will not be applied atomically.
This problem is slightly mitigated by the fact that Hibernate OGM queues all changes
before applying them during flush time.
So the window of time used to write to MongoDB is smaller than what you would have done manually.</p><p>We recommend that you still use transaction demarcations with Hibernate OGM
to trigger the flush operation transparently (on commit).
But do not consider rollback as a possibility, this won’t work.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-mongodb-queries"/>5.3.4. Queries</h3></div></div></div><p>You can express queries in a few different ways:</p><div class="itemizedlist"><ul><li>using JP-QL</li><li>using a native MongoQL query</li><li>using a Hibernate Search query (brings advanced full-text and geospatial queries)</li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>In order to reflect changes performed in the current session,
all entities affected by a given query are flushed to the datastore prior to query execution
(that’s the case for Hibernate ORM as well as Hibernate OGM).</p><p>For not fully transactional stores such as MongoDB
this can cause changes to be written as a side-effect of running queries
which cannot be reverted by a possible later rollback.</p><p>Depending on your specific use cases and requirements you may prefer to disable auto-flushing,
e.g. by invoking <code class="literal">query.setFlushMode( FlushMode.MANUAL )</code>.
Bear in mind though that query results will then not reflect changes applied within the current session.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_jp_ql_queries"/>5.3.4.1. JP-QL queries</h4></div></div></div><p>Hibernate OGM is a work in progress, so only a sub-set of JP-QL constructs is available
when using the JP-QL query support. This includes:</p><div class="itemizedlist"><ul><li>simple comparisons using "&lt;", "⇐", "=", "&gt;=" and "&gt;"</li><li><code class="literal">IS NULL</code> and <code class="literal">IS NOT NULL</code></li><li>the boolean operators <code class="literal">AND</code>, <code class="literal">OR</code>, <code class="literal">NOT</code></li><li><code class="literal">LIKE</code>, <code class="literal">IN</code> and <code class="literal">BETWEEN</code></li><li><code class="literal">ORDER BY</code></li></ul></div><p>Queries using these constructs will be transformed into equivalent native MongoDB queries.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_native_mongodb_queries"/>5.3.4.2. Native MongoDB queries</h4></div></div></div><p>Hibernate OGM also supports certain forms of native queries for MongoDB.
Currently two forms of native queries are available via the MongoDB backend:</p><div class="itemizedlist"><ul><li>find queries specifying the search criteria only</li><li>queries specified using the MongoDB CLI syntax</li></ul></div><p>The former always maps results to entity types.
The latter either maps results to entity types or to certain supported forms of projection.
Note that parameterized queries are not supported by MongoDB, so don’t expect <code class="literal">Query#setParameter()</code> to work.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Specifying native MongoDB queries using the CLI syntax is an EXPERIMENTAL feature for the time being.
Currently only <code class="literal">find()</code> and <code class="literal">count()</code> queries are supported via the CLI syntax.
Further query types (including updating queries) may be supported in future revisions.</p><p>No cursor operations such as <code class="literal">sort()</code> are supported.
Instead use the corresponding MongoDB <a class="ulink" href="http://docs.mongodb.org/manual/reference/operator/query-modifier/">query modifiers</a>
such as <code class="literal">$orderby</code> within the criteria parameter.</p><p>JSON parameters passed via the CLI syntax must be specified using the <a class="ulink" href="http://docs.mongodb.org/manual/reference/mongodb-extended-json/">strict mode</a>
The only relaxation of this is that single quotes may be used when specifying attribute names/values to facilitate embedding
queries within Java strings.</p><p>Note that results of projections are returned as retrieved from the MongoDB driver at the moment and
are not (yet) converted using suitable Hibernate OGM type implementations.</p></div><p>You can execute native queries as shown in the following example:</p><div class="example"><a id="d0e2844"/><p class="title"><b>Example 5.17. Using the JPA API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;author</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">javax</span><span class="java_separator">.</span><span class="java_plain">persistence</span><span class="java_separator">.</span><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;criteria</span><span class="java_operator">-</span><span class="java_plain">only&nbsp;find&nbsp;syntax</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;{&nbsp;$and:&nbsp;[&nbsp;{&nbsp;name&nbsp;:&nbsp;'Portia'&nbsp;},&nbsp;{&nbsp;author&nbsp;:&nbsp;'Oscar&nbsp;Wilde'&nbsp;}&nbsp;]&nbsp;}&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;criteria</span><span class="java_operator">-</span><span class="java_plain">only&nbsp;find&nbsp;syntax&nbsp;with&nbsp;order</span><span class="java_operator">-</span><span class="java_plain">by</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;{&nbsp;$query&nbsp;:&nbsp;{&nbsp;author&nbsp;:&nbsp;'Oscar&nbsp;Wilde'&nbsp;},&nbsp;$orderby&nbsp;:&nbsp;{&nbsp;name&nbsp;:&nbsp;1&nbsp;}&nbsp;}&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Poem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poems&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query2</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;projection&nbsp;via&nbsp;CLI</span><span class="java_operator">-</span><span class="java_plain">syntax</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query3&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;db.WILDE_POEM.find(&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;{&nbsp;'$query'&nbsp;:&nbsp;{&nbsp;'name'&nbsp;:&nbsp;'Athanasia'&nbsp;},&nbsp;'$orderby'&nbsp;:&nbsp;{&nbsp;'name'&nbsp;:&nbsp;1&nbsp;}&nbsp;}&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;{&nbsp;'name'&nbsp;:&nbsp;1&nbsp;}&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;)&quot;</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;will&nbsp;contain&nbsp;name&nbsp;and&nbsp;id&nbsp;as&nbsp;</span><span class="java_type">MongoDB</span><span class="java_plain">&nbsp;always&nbsp;returns&nbsp;the&nbsp;id&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;projections</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poemNames&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_operator">&gt;</span><span class="java_separator">)</span><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query3&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;projection&nbsp;via&nbsp;CLI</span><span class="java_operator">-</span><span class="java_plain">syntax</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query4&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;db.WILDE_POEM.count({&nbsp;'name'&nbsp;:&nbsp;'Athanasia'&nbsp;})&quot;</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;count&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Object</span><span class="java_separator">[])</span><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query4&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>The result of a query is a managed entity (or a list thereof) or a projection of attributes in form of an object array,
just like you would get from a JP-QL query.</p><div class="example"><a id="d0e2851"/><p class="title"><b>Example 5.18. Using the Hibernate native API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">OgmSession</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;{&nbsp;$and:&nbsp;[&nbsp;{&nbsp;name&nbsp;:&nbsp;'Portia'&nbsp;},&nbsp;{&nbsp;author&nbsp;:&nbsp;'Oscar&nbsp;Wilde'&nbsp;}&nbsp;]&nbsp;}&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Poem&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">uniqueResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;{&nbsp;$query&nbsp;:&nbsp;{&nbsp;author&nbsp;:&nbsp;'Oscar&nbsp;Wilde'&nbsp;},&nbsp;$orderby&nbsp;:&nbsp;{&nbsp;name&nbsp;:&nbsp;1&nbsp;}&nbsp;}&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Poem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poems&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Poem&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>As <code class="literal">OgmSession</code> extends <code class="literal">org.hibernate.Session</code> (which originally has been designed with relational databases in mind only)
you could also invoke <code class="literal">createSQLQuery()</code> to create a native query. But for the sake of comprehensibility, you should prefer
<code class="literal">createNativeQuery()</code>, and in fact <code class="literal">createSQLQuery()</code> has been deprecated on <code class="literal">OgmSession</code>.</p></div><p>Native queries can also be created using the <code class="literal">@NamedNativeQuery</code> annotation:</p><div class="example"><a id="d0e2882"/><p class="title"><b>Example 5.19. Using @NamedNativeQuery</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;{&nbsp;$and:&nbsp;[&nbsp;{&nbsp;name&nbsp;:&nbsp;'Athanasia'&nbsp;},&nbsp;{&nbsp;author&nbsp;:&nbsp;'Oscar&nbsp;Wilde'&nbsp;}&nbsp;]&nbsp;}&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;resultClass&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Using</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">EntityManager</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNamedQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Using</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">Session</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">getNamedQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">uniqueResult</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Hibernate OGM stores data in a natural way so you can still execute queries using the
MongoDB driver, the main drawback is that the results are going to be raw MongoDB
documents and not managed entities.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_hibernate_search"/>5.3.4.3. Hibernate Search</h4></div></div></div><p>You can index your entities using Hibernate Search.
That way, a set of secondary indexes independent of MongoDB is maintained by Hibernate Search
and you can write queries on top of them.
The benefit of this approach is a nice integration at the JPA / Hibernate API level
(managed entities are returned by the queries).
The drawback is that you need to store the Lucene indexes somewhere
(file system, infinispan grid, etc).
Have a look at the Infinispan section (<a class="xref" href="ogm-datastore-providers.html#ogm-infinispan-indexstorage" title="5.1.5. Storing a Lucene index in Infinispan">Section 5.1.5, “Storing a Lucene index in Infinispan”</a>)
for more info on how to use Hibernate Search.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-neo4j"/>5.4. Neo4j</h2></div></div></div><p><a class="ulink" href="http://www.neo4j.org">Neo4j</a> is a robust (fully ACID) transactional property graph database.
This kind of databases are suited for those type of problems that can be represented with a graph
like social relationships or road maps for example.</p><p>At the moment only the support for the embedded Neo4j is included in OGM.</p><p>This is our first version and a bit experimental. In particular we plan on using node navigation much more than index lookup in a future version.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_how_to_add_neo4j_integration"/>5.4.1. How to add Neo4j integration</h3></div></div></div><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">1. Add the dependencies to your project</h5><p class="formalpara">If your project uses Maven you can add this to the pom.xml:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ogm</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-ogm-neo4j</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">4.1.0.Beta8</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>Alternatively you can find the required libraries in the distribution package on <a class="ulink" href="https://downloads.sourceforge.net/project/hibernate/hibernate-ogm/4.1.0.Beta8/hibernate-ogm-4.1.0.Beta8-dist.zip">SourceForge</a></p><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">2. Add the following properties:</h5><p class="formalpara">
</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="PROPERTIES">hibernate.ogm.datastore.provider = neo4j_embedded
hibernate.ogm.neo4j.database_path = C:\example\mydb</pre><p class="formalpara">
</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_neo4j"/>5.4.2. Configuring Neo4j</h3></div></div></div><p>The following properties are available to configure Neo4j support:</p><div class="variablelist"><p class="title"><b>Neo4j datastore configuration properties</b></p><dl><dt><span class="term">hibernate.ogm.neo4j.database_path</span></dt><dd>The absolute path representing the location of the Neo4j database. Example: <code class="literal">C:\neo4jdb\mydb</code></dd><dt><span class="term">hibernate.ogm.neo4j.configuration_resource_name (optional)</span></dt><dd>Location of the Neo4j embedded properties file. It can be an URL, name of a classpath resource or file system path.</dd><dt><span class="term">hibernate.schema_update.unique_constraint_strategy (optional)</span></dt><dd>If set to <code class="literal">SKIP</code>, Hibernate OGM won’t create any unique constraints on the nodes representing the entities.
This property won’t affect the unique constraints generated for sequences.
Other possible values (defined on the <code class="literal">org.hibernate.tool.hbm2ddl.UniqueConstraintSchemaUpdateStrategy</code> enum) are <code class="literal">DROP_RECREATE_QUIETLY</code> and <code class="literal">RECREATE_QUIETLY</code>
but the effect will be the same (since Neo4j constraints don’t have a name):
keep the existing constraints and create the missing one.
Default value is <code class="literal">DROP_RECREATE_QUIETLY</code>.</dd></dl></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>At the moment, you must not specify the property <code class="literal">hibernate.transaction.jta.platform</code> when using Neo4j.
When this property is explicitly set it will override the specific JtaPlatform required to integrate OGM with Neo4j
causing transaction not to work correctly.</p></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Use the following method to retrieve the transaction manager (it needs to be done after the EMF has been bootstrapped):</p><pre xmlns="" class="JAVA"><!-- <br/> --><span class="java_keyword">private</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">static</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">TransactionManager</span><!-- <br/> --><span class="java_plain">&nbsp;extractJBossTransactionManager</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">EntityManagerFactory</span><!-- <br/> --><span class="java_plain">&nbsp;factory</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">SessionFactoryImplementor</span><span class="java_plain">&nbsp;sessionFactory&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">SessionFactoryImplementor</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">HibernateEntityManagerFactory</span><span class="java_separator">)</span><span class="java_plain">&nbsp;factory&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getSessionFactory</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getServiceRegistry</span><span class="java_separator">().</span><span class="java_plain">getService</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">JtaPlatform</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">retrieveTransactionManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span></pre></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code class="literal">Neo4jProperties</code>
when specifying the configuration properties listed above.
Common properties shared between stores are declared on <code class="literal">OgmProperties</code>.
To ease migration between stores, it is recommended to reference these constants directly from there.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-neo4j-storage-principles"/>5.4.3. Storage principles</h3></div></div></div><p>Hibernate OGM tries to make the mapping to the underlying datastore as natural as possible
so that third party applications not using Hibernate OGM can still read
and update the same datastore.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The mappings are still EXPERIMENTAL and they might change in future.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_entities_2"/>5.4.3.1. Entities</h4></div></div></div><p>Entities are stored as Neo4j nodes, which means each entity property will be translated into a property of the node.
The name of the table mapping the entity is used as label.</p><p>You can use the name property of the <code class="literal"><span class="classname">@Table</span></code> and <code class="literal"><span class="classname">@Column</span></code> annotations
to rename the label and the node’s properties.</p><p>An additional label <code class="literal">ENTITY</code> is added to the node.</p><div class="example"><a id="d0e3020"/><p class="title"><b>Example 5.20. Example of entity and the corresponding representation using Cypher</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;login</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;password</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre class="screen">Using Cypher:

(n:Account:ENTITY {login: '...', password: '...'})</pre></div></div><br class="example-break"/><div class="example"><a id="d0e3027"/><p class="title"><b>Example 5.21. Example of enitty with @Embaddable</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;login</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;password</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Address</span><span class="java_plain">&nbsp;homeAddress</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Embeddable</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;street1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;street2</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;city</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;country</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;postal_code&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;zipCode</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre class="screen">(n:Account:ENTITY {login: ...,
                   , password: ...
                   , `homeAddress.street1`: ...
                   , `homeAddress.city`: ...
                   , `homeAddress.country`: ...
                   , postal_code`: ...})</pre></div></div><br class="example-break"/><p>Currently an embeddable element is stored saving the values on the node that represents the entity.</p><p>Hibernate OGM will create unique constraints for the identifier of entities and for the properties defined
as unique using:</p><div class="itemizedlist"><ul><li>@NaturalId</li><li>@Column(unique = true)</li><li><p>@Table(uniqueConstraints = @UniqueConstraint(columnNames = { "column_name" }</p><pre class="literallayout">Neo4j does not support constraints on more than one property.
For this reason, Hibernate OGM will create a unique constraint only when
defined on a single column and it will ignore the ones defined on multiple columns.</pre></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_associations_2"/>5.4.3.2. Associations</h4></div></div></div><p>An association, bidirectional or unidirectional, is always mapped using one relationship,
beginning at the owning side of the association.
This is possible because in Neo4j relationships can be navigated in both directions.</p><p>The type of the relationships depends on the type of the association,
but in general it is the role of the association on the main side.
The only property stored on the relationship is going to be the index of the association when required,
for example when the association is annotated with <code class="literal">@OrderColumn</code> or when a <code class="literal">java.util.Map</code> is used.</p><div class="example"><a id="d0e3063"/><p class="title"><b>Example 5.22. Example of bidirectional @ManyToMany</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">AccountOwner</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;sSN</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">BankAccount</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bankAccounts&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashSet</span><span class="java_operator">&lt;</span><span class="java_type">BankAccount</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">BankAccount</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;accountNumber</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToMany</span><span class="java_separator">(</span><span class="java_plain">mappedBy&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;bankAccounts&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">AccountOwner</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;owners&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashSet</span><span class="java_operator">&lt;</span><span class="java_type">AccountOwner</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre class="screen">(:AccountOwner:ENTITY {...}) - [:bankAccounts] -&gt; (:BankAccount:ENTITY {...})</pre></div></div><br class="example-break"/><div class="example"><a id="d0e3070"/><p class="title"><b>Example 5.23. Example of unidirectional @ManyToOne with @OrderColumn</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Father</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OrderColumn</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;birthorder&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Child</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;children&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">Child</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Child</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><pre class="screen">(:Father:ENTITY {...}) - [:children { birthorder: 0 }] -&gt; (:Child:ENTITY {...})
(:Father:ENTITY {...}) - [:children { birthorder: 1 }] -&gt; (:Child:ENTITY {...})</pre></div></div><br class="example-break"/><div class="example"><a id="d0e3077"/><p class="title"><b>Example 5.24. Example of bidirectional @OneToOne</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Husband</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Wife</span><span class="java_plain">&nbsp;wife</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;getId</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToOne</span><span class="java_separator">(</span><span class="java_plain">fetch&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchType</span><span class="java_separator">.</span><span class="java_plain">LAZY</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;wife&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Wife</span><span class="java_plain">&nbsp;getWife</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;wife</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setWife</span><span class="java_separator">(</span><span class="java_type">Wife</span><span class="java_plain">&nbsp;wife</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">wife&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;wife</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Wife</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;getId</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToOne</span><span class="java_separator">(</span><span class="java_plain">mappedBy&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;wife&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Husband</span><span class="java_plain">&nbsp;getHusband</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;husband</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</pre><pre class="screen">(:Wife:ENTITY { id: 1, name: "Karen" }) &lt;- [:wife] - (:Husband:ENTITY {id: 2, name: "Mark"})</pre></div></div><br class="example-break"/><div class="example"><a id="d0e3084"/><p class="title"><b>Example 5.25. Example of collection of @Embeddable</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">MultiAddressAccount</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;login</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;password</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;addresses&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getLogin</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;login</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ElementCollection</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getAddresses</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;addresses</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setAddresses</span><span class="java_separator">(</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;addresses</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">addresses&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;addresses</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Embeddable</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;street1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;street2</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;city</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;country</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;postal_code&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;zipCode</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre class="screen">(:MultiAddressAccount:ENTITY{login: '...', password: '...' }) - [:addresses] -&gt; (:MultiAddressAccount_addresses:EMBEDDED {street1: '...', city: '...', country: '...', postal_code: '...'})</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_auto_generated_values"/>5.4.3.3. Auto-generated Values</h4></div></div></div><p>Hibernate OGM supports the table generation strategy as well as the sequence generation strategy with Neo4j.
It is generally recommended to work with the latter,
as it allows a slightly more efficient querying for the next sequence value.</p><p>Sequence-based generators are represented by nodes in the following form:</p><div class="example"><a id="d0e3098"/><p class="title"><b>Example 5.26. Example of a sequence-based generator using Cypher</b></p><div class="example-contents"><pre class="screen">(:SEQUENCE { sequence_name = 'ExampleSequence', next_val : 3 })</pre></div></div><br class="example-break"/><p>Each sequence generator node is labelled with <code class="literal">SEQUENCE</code>.
The sequence name can be specified via <code class="literal">@SequenceGenerator#sequenceName()</code>.
A unique constraint is applied to the property <code class="literal">sequence_name</code> in order to ensure uniqueness of sequences.</p><p>If required, you can set the initial value of a sequence and the increment size via
<code class="literal">@SequenceGenerator#initialValue()</code> and <code class="literal">@SequenceGenerator#allocationSize()</code>, respectively.
The options <code class="literal">@SequenceGenerator#catalog()</code> and <code class="literal">@SequenceGenerator#schema()</code> are not supported.</p><p>Table-based generators are represented by nodes in the following form:</p><div class="example"><a id="d0e3130"/><p class="title"><b>Example 5.27. Example of a table-based generator using Cypher</b></p><div class="example-contents"><pre class="screen">(:hibernate_sequences:TABLE_BASED_SEQUENCE { sequence_name = 'ExampleSequence', current_value : 3 })</pre></div></div><br class="example-break"/><p>Each table generator node is labelled with <code class="literal">TABLE_BASED_SEQUENCE</code>
and the table name as specified via <code class="literal">@TableGenerator#table()</code>.
The sequence name is to be given via <code class="literal">@TableGenerator#pkColumnValue()</code>.
The node properties holding the sequence name and value can be configured via
<code class="literal">@TableGenerator#pkColumnName()</code> and <code class="literal">@TableGenerator#valueColumnName()</code>, respectively.
A unique constraint is applied to the property <code class="literal">sequence_name</code> to avoid the same sequence name is used twice within the same "table".</p><p>If required, you can set the initial value of a sequence and the increment size via
<code class="literal">@TableGenerator#initialValue()</code> and <code class="literal">@TableGenerator#allocationSize()</code>, respectively.
The options <code class="literal">@TableGenerator#catalog()</code>, <code class="literal">@TableGenerator#schema()</code>, <code class="literal">@TableGenerator#uniqueConstraints()</code> and <code class="literal">@TableGenerator#indexes()</code>  are not supported.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-neo4j-transactions"/>5.4.4. Transactions</h3></div></div></div><p>Neo4j operations can be executed only inside a transaction.
Unless a different <code class="literal">org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform</code> is specified, OGM will use a specific implementation to integrate with the Neo4j transaction mechanism.
This means that you can start and commit transaction using the Hibernate session.</p><p>The drawback is that it is not possible at the moment to let Neo4j participate in managed JTA transactions spanning several resources (see issue <a class="ulink" href="https://hibernate.atlassian.net/browse/OGM-370">OGM-370</a>).</p><div class="example"><a id="d0e3188"/><p class="title"><b>Example 5.28. Example of starting and committing transactions</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;factory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">Account</span><span class="java_plain">&nbsp;account&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">account</span><span class="java_separator">.</span><span class="java_plain">setLogin</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;myAccount&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">&nbsp;account&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Account</span><span class="java_plain">&nbsp;savedAccount&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">Account</span><span class="java_separator">)</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Account</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;account</span><span class="java_separator">.</span><span class="java_plain">getId</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-neo4j-queries"/>5.4.5. Queries</h3></div></div></div><p>You can express queries in a few different ways:</p><div class="itemizedlist"><ul><li>using JP-QL</li><li>using the Cypher query language</li><li>using a Hibernate Search query (brings advanced full-text and geospatial queries)</li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_jp_ql_queries_2"/>5.4.5.1. JP-QL queries</h4></div></div></div><p>Hibernate OGM is a work in progress, so only a sub-set of JP-QL constructs is available
when using the JP-QL query support. This includes:</p><div class="itemizedlist"><ul><li>simple comparisons using "&lt;", "⇐", "=", "&gt;=" and "&gt;"</li><li><code class="literal">IS NULL</code> and <code class="literal">IS NOT NULL</code></li><li>the boolean operators <code class="literal">AND</code>, <code class="literal">OR</code>, <code class="literal">NOT</code></li><li><code class="literal">LIKE</code>, <code class="literal">IN</code> and <code class="literal">BETWEEN</code></li><li><code class="literal">ORDER BY</code></li></ul></div><p>Queries using these constructs will be transformed into equivalent <a class="ulink" href="http://docs.neo4j.org/chunked/stable/cypher-query-lang.html">Cypher queries</a>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_cypher_queries"/>5.4.5.2. Cypher queries</h4></div></div></div><p>Hibernate OGM also supports <a class="ulink" href="http://docs.neo4j.org/chunked/stable/cypher-query-lang.html">Cypher queries</a> for Neo4j.
You can execute Cypher queries as shown in the following example:</p><div class="example"><a id="d0e3262"/><p class="title"><b>Example 5.29. Using the JPA API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;author</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">javax</span><span class="java_separator">.</span><span class="java_plain">persistence</span><span class="java_separator">.</span><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;a&nbsp;single&nbsp;result&nbsp;query</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MATCH&nbsp;(&nbsp;n:Poem&nbsp;{&nbsp;name:'Portia',&nbsp;author:'Oscar&nbsp;Wilde'&nbsp;}&nbsp;)&nbsp;RETURN&nbsp;n&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;query&nbsp;with&nbsp;order&nbsp;by</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MATCH&nbsp;(&nbsp;n:Poem&nbsp;{&nbsp;name:'Portia',&nbsp;author:'Oscar&nbsp;Wilde'&nbsp;}&nbsp;)&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;RETURN&nbsp;n&nbsp;ORDER&nbsp;BY&nbsp;n.name&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Poem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poems&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query2</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;query&nbsp;with&nbsp;projections</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query3&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;MATCH&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;n</span><span class="java_operator">:</span><span class="java_type">Poem</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;RETURN&nbsp;n</span><span class="java_separator">.</span><span class="java_plain">name</span><span class="java_separator">,</span><span class="java_plain">&nbsp;n</span><span class="java_separator">.</span><span class="java_plain">author&nbsp;ORDER&nbsp;BY&nbsp;n</span><span class="java_separator">.</span><span class="java_plain">name&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poemNames&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_operator">&gt;</span><span class="java_separator">)</span><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query3&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><p>The result of a query is a managed entity (or a list thereof) or a projection of attributes in form of an object array,
just like you would get from a JP-QL query.</p><div class="example"><a id="d0e3269"/><p class="title"><b>Example 5.30. Using the Hibernate native API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">OgmSession</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MATCH&nbsp;(&nbsp;n:Poem&nbsp;{&nbsp;name:'Portia',&nbsp;author:'Oscar&nbsp;Wilde'&nbsp;}&nbsp;)&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;RETURN&nbsp;n&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query1&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Poem&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">uniqueResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MATCH&nbsp;(&nbsp;n:Poem&nbsp;{&nbsp;name:'Portia',&nbsp;author:'Oscar&nbsp;Wilde'&nbsp;}&nbsp;)&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;RETURN&nbsp;n&nbsp;ORDER&nbsp;BY&nbsp;n.name&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Poem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;poems&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query2&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Poem&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>As <code class="literal">OgmSession</code> extends <code class="literal">org.hibernate.Session</code> (which originally has been designed with relational databases in mind only)
you could also invoke <code class="literal">createSQLQuery()</code> to create a native query. But for the sake of comprehensibility, you should prefer
<code class="literal">createNativeQuery()</code>, and in fact <code class="literal">createSQLQuery()</code> has been deprecated on <code class="literal">OgmSession</code>.</p></div><p>Native queries can also be created using the <code class="literal">@NamedNativeQuery</code> annotation:</p><div class="example"><a id="d0e3300"/><p class="title"><b>Example 5.31. Using @NamedNativeQuery</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;MATCH&nbsp;(&nbsp;n:Poem&nbsp;{&nbsp;name:'Athanasia',&nbsp;author:'Oscar&nbsp;Wilde'&nbsp;}&nbsp;)&nbsp;RETURN&nbsp;n&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;resultClass&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Poem</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Using</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">EntityManager</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNamedQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Using</span><span class="java_plain">&nbsp;the&nbsp;</span><span class="java_type">Session</span>
<!--  --><br/><span class="java_type">Poem</span><span class="java_plain">&nbsp;poem2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Poem</span><span class="java_separator">)</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">getNamedQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;AthanasiaPoem&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">uniqueResult</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Hibernate OGM stores data in a natural way so you can still execute queries using your favorite tool,
the main drawback is that the results are going to be raw Neo4j elements and not managed entities.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_hibernate_search_2"/>5.4.5.3. Hibernate Search</h4></div></div></div><p>You can index your entities using Hibernate Search.
That way, a set of secondary indexes independent of Neo4j is maintained by Hibernate Search
and you can write queries on top of them.
The benefit of this approach is a nice integration at the JPA / Hibernate API level
(managed entities are returned by the queries).
The drawback is that you need to store the Lucene indexes somewhere
(file system, infinispan grid, etc).
Have a look at the Infinispan section (<a class="xref" href="ogm-datastore-providers.html#ogm-infinispan-indexstorage" title="5.1.5. Storing a Lucene index in Infinispan">Section 5.1.5, “Storing a Lucene index in Infinispan”</a>)
for more info on how to use Hibernate Search.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ogm-couchdb"/>5.5. CouchDB</h2></div></div></div><p><a class="ulink" href="https://couchdb.apache.org/">CouchDB</a> is a document-oriented datastore
which stores your data in form of JSON documents and exposes its API via HTTP based on REST principles.
It is thus very easy to access from a wide range of languages and applications.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Support for CouchDB is considered an EXPERIMENTAL feature as of this release.
In particular you should be prepared for possible changes to the persistent representation of mapped objects in future releases.
Should you find any bugs or have feature requests for this dialect,
then please open a ticket in the <a class="ulink" href="https://hibernate.atlassian.net/browse/OGM">OGM issue tracker</a>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_couchdb"/>5.5.1. Configuring CouchDB</h3></div></div></div><p>Hibernate OGM uses the excellent <a class="ulink" href="https://www.jboss.org/resteasy">RESTEasy</a> library to talk to CouchDB stores,
so there is no need to include any of the Java client libraries for CouchDB in your classpath.</p><p>The following properties are available to configure CouchDB support in Hibernate OGM:</p><div class="variablelist"><p class="title"><b>CouchDB datastore configuration properties</b></p><dl><dt><span class="term">hibernate.ogm.datastore.provider</span></dt><dd>To use CouchDB as a datastore provider, this property must be set to <code class="literal">couchdb</code></dd><dt><span class="term">hibernate.ogm.option.configurator</span></dt><dd>The fully-qualified class name or an instance of a programmatic option configurator (see <a class="xref" href="ogm-datastore-providers.html#ogm-couchdb-programmatic-configuration" title="5.5.1.2. Programmatic configuration">Section 5.5.1.2, “Programmatic configuration”</a>)</dd><dt><span class="term">hibernate.ogm.datastore.host</span></dt><dd>The hostname of the CouchDB instance. The default value is <code class="literal">127.0.0.1</code>.</dd><dt><span class="term">hibernate.ogm.datastore.port</span></dt><dd>The port used by the CouchDB instance. The default value is <code class="literal">5984</code>.</dd><dt><span class="term">hibernate.ogm.datastore.database</span></dt><dd>The database to connect to. This property has no default value.</dd><dt><span class="term">hibernate.ogm.datastore.create_database</span></dt><dd>Whether to create the specified database in case it does not exist or not.
Can be <code class="literal">true</code> or <code class="literal">false</code> (default). Note that the specified user must have the right to
create databases if set to <code class="literal">true</code>.</dd><dt><span class="term">hibernate.ogm.datastore.username</span></dt><dd>The username used when connecting to the CouchDB server.
Note that this user must have the right to create design documents in the chosen database.
This property has no default value.
Hibernate OGM currently does not support accessing CouchDB via HTTPS;
if you’re interested in such functionality, let us know.</dd><dt><span class="term">hibernate.ogm.datastore.password</span></dt><dd>The password used to connect to the CouchDB server.
This property has no default value.
This property is ignored if the username isn’t specified.</dd><dt><span class="term">hibernate.ogm.datastore.document.association_storage</span></dt><dd>Defines the way OGM stores association information in CouchDB.
The following two strategies exist (values of the <code class="literal">org.hibernate.ogm.datastore.document.options.AssociationStorageType</code> enum):
<code class="literal">IN_ENTITY</code> (store association information within the entity) and
<code class="literal">ASSOCIATION_DOCUMENT</code> (store association information in a dedicated document per association).
<code class="literal">IN_ENTITY</code> is the default and recommended option
unless the association navigation data is much bigger than the core of the document and leads to performance degradation.</dd></dl></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>When bootstrapping a session factory or entity manager factory programmatically,
you should use the constants accessible via <code class="literal">CouchDBProperties</code>
when specifying the configuration properties listed above.
Common properties shared between (document) stores are declared on <code class="literal">OgmProperties</code> and <code class="literal">DocumentStoreProperties</code>, respectively.
To ease migration between stores, it is recommended to reference these constants directly from there.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-couchdb-annotation-configuration"/>5.5.1.1. Annotation based configuration</h4></div></div></div><p>Hibernate OGM allows to configure store-specific options via Java annotations.
When working with the CouchDB backend, you can specify how associations should be stored
using the <code class="literal">AssociationStorage</code> annotation
(refer to <a class="xref" href="ogm-datastore-providers.html#ogm-couchdb-storage-principles" title="5.5.2. Storage principles">Section 5.5.2, “Storage principles”</a> to learn more about association storage strategies in general).</p><p>The following shows an example:</p><div class="example"><a id="d0e3449"/><p class="title"><b>Example 5.32. Configuring the association storage strategy using annotations</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">AssociationStorage</span><span class="java_separator">(</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Zoo</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Animal</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;animals</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;employees</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">AssociationStorage</span><span class="java_separator">(</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">IN_ENTITY</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;visitors</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The annotation on the entity level expresses that all associations of the <code class="literal">Zoo</code>
class should be stored in separate assocation documents.
This setting applies to the <code class="literal">animals</code> and <code class="literal">employees</code> associations.
Only the elements of the <code class="literal">visitors</code> association will be stored in the document of the corresponding <code class="literal">Zoo</code> entity
as per the configuration of that specific property which takes precedence over the entity-level configuration.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ogm-couchdb-programmatic-configuration"/>5.5.1.2. Programmatic configuration</h4></div></div></div><p>In addition to the annotation mechanism,
Hibernate OGM also provides a programmatic API for applying store-specific configuration options.
This can be useful if you can’t modify certain entity types or
don’t want to add store-specific configuration annotations to them.
The API allows set options in a type-safe fashion on the global, entity and property levels.</p><p>When working with CouchDB, you can currently configure the following options using the API:</p><div class="itemizedlist"><ul><li>association storage strategy (on the global, entity and property level)</li></ul></div><p>To set this option via the API, you need to create an <code class="literal">OptionConfigurator</code> implementation
as shown in the following example:</p><div class="example"><a id="d0e3487"/><p class="title"><b>Example 5.33. Example of an option configurator</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">MyOptionConfigurator</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">OptionConfigurator</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;configure</span><span class="java_separator">(</span><span class="java_type">Configurable</span><span class="java_plain">&nbsp;configurable</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configurable</span><span class="java_separator">.</span><span class="java_plain">configureOptionsFor</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">CouchDB</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Zoo</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">property</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;visitors&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">ElementType</span><span class="java_separator">.</span><span class="java_plain">FIELD&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">IN_ENTITY&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Animal</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">associationStorage</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">AssociationStorageType</span><span class="java_separator">.</span><span class="java_plain">ASSOCIATION_DOCUMENT&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>The call to <code class="literal">configureOptionsFor()</code>, passing the store-specific identifier type <code class="literal">CouchDB</code>,
provides the entry point into the API. Following the fluent API pattern, you then can configure
global options and navigate to single entities or properties to apply options specific to these.</p><p>Options given on the property level precede entity-level options. So e.g. the <code class="literal">visitors</code> association of the <code class="literal">Zoo</code>
class would be stored using the in-entity strategy, while all other associations of the <code class="literal">Zoo</code> entity would
be stored using separate association documents.</p><p>Similarly, entity-level options take precedence over options given on the global level.
Global-level options specified via the API complement the settings given via configuration properties.
In case a setting is given via a configuration property and the API at the same time,
the latter takes precedence.</p><p>Note that for a given level (property, entity, global),
an option set via annotations is overridden by the same option set programmatically.
This allows you to change settings in a more flexible way if required.</p><p>To register an option configurator, specify its class name using the <code class="literal">hibernate.ogm.option.configurator</code> property.
When bootstrapping a session factory or entity manager factory programmatically,
you also can pass in an <code class="literal">OptionConfigurator</code> instance or the class object representing the configurator type.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ogm-couchdb-storage-principles"/>5.5.2. Storage principles</h3></div></div></div><p>Hibernate OGM tries to make the mapping to the underlying datastore as natural as possible
so that third party applications not using Hibernate OGM can still read
and update the same datastore.
The following describe how entities and associations are mapped to CouchDB documents by Hibernate OGM.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_entities_3"/>5.5.2.1. Entities</h4></div></div></div><p>Entities are stored as CouchDB documents and not as BLOBs
which means each entity property will be translated into a document field.
You can use the name property of the <code class="literal"><span class="classname">@Table</span></code> and <code class="literal"><span class="classname">@Column</span></code> annotations
to rename the collections and the document’s fields if you need to.</p><p>CouchDB provides a built-in mechanism for detecting concurrent updates to one and the same document.
For that purpose each document has an attribute named <code class="literal">_rev</code> (for "revision")
which is to be passed back to the store when doing an update.
So when writing back a document and the document’s revision has been altered by another writer in parallel,
CouchDB will raise an optimistic locking error
(you could then e.g. re-read the current document version and try another update).</p><p>For this mechanism to work, you need to declare a property for the <code class="literal">_rev</code> attribute in all your entity types
and mark it with the <code class="literal">@Version</code> and <code class="literal">@Generated</code> annotations.
The first marks it as a property used for optimistic locking, while the latter advices Hibernate OGM
to refresh that property after writes since its value is managed by the datastore.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Not mapping the <code class="literal">_rev</code> attribute may cause lost updates,
as Hibernate OGM needs to re-read the current revision before doing an update in this case.
Thus a warning will be issued during initialization for each entity type which fails to map that property.</p></div><p>The following shows an example of an entity and its persistent representation in CouchDB.</p><div class="example"><a id="d0e3565"/><p class="title"><b>Example 5.34. Example of an entity and its representation in CouchDB</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">News</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Generated</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;_rev&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;revision</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;title</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;desc&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id": "News:id_:news-1_",
    "_rev": "1-d1cd3b00a677a2e31cd0480a796e8480",
    "$type": "entity",
    "$table": "News",
    "title": "On the merits of NoSQL",
    "desc": "This paper discuss why NoSQL will save the world for good"
}</pre></div></div><br class="example-break"/><p>Note that CouchDB doesn’t have a concept of "tables" or "collections" as e.g. MongoDB does;
Instead all documents are stored in one large bucket.
Thus Hibernate OGM needs to add two additional attributes:
<code class="literal">$type</code> which contains the type of a document (entity vs. association documents)
and <code class="literal">$table</code> which specifies the entity name as derived from the type or given via the <code class="literal">@Table</code> annotation.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Attributes whose name starts with the "$" character are managed by Hibernate OGM and
thus should not be modified manually.
Also it is not recommended to start the names of your attributes with the "$" character to avoid collisions
with attributes possibly introduced by Hibernate OGM in future releases.</p></div><p>Embedded objects are mapped as nested documents.
The following listing shows an example:</p><div class="example"><a id="d0e3588"/><p class="title"><b>Example 5.35. Example of an entity with an embedded object</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">News</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Generated</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;_rev&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;revision</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;title</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;desc&quot;</span><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;description</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Embedded</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsPaper</span><span class="java_plain">&nbsp;paper</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Embeddable</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">NewsPaper</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;owner</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id": "News:id_:news-1_",
    "_rev": "1-d1cd3b00a677a2e31cd0480a796e8480",
    "$type": "entity",
    "$table": "News",
    "title": "On the merits of NoSQL",
    "desc": "This paper discuss why NoSQL will save the world for good",
    "paper": {
        "name": "NoSQL journal of prophecies",
        "owner": "Delphy"
    }
}</pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_identifiers_2"/>5.5.2.1.1. Identifiers</h5></div></div></div><p>The <code class="literal">_id</code> field of a CouchDB document is directly used
to store the identifier columns mapped in the entities.
You can use any persistable Java type as identifier type, e.g. <code class="literal">String</code> or <code class="literal">long</code>.</p><p>Hibernate OGM will convert the <code class="literal">@Id</code> property into a <code class="literal">_id</code> document field
so you can name the entity id like you want, it will always be stored into <code class="literal">_id</code>.</p><p>Note that you also can work with embedded ids (via <code class="literal">@EmbeddedId</code>),
but be aware of the fact that CouchDB doesn’t support storing embedded structures in the <code class="literal">_id</code> attribute.
Hibernate OGM thus will create a concatenated representation of the embedded id’s properties in this case.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_associations_3"/>5.5.2.2. Associations</h4></div></div></div><p>Hibernate OGM CouchDB provides two strategies to store navigation information for associations.
To switch between these strategies,
either use the <code class="literal">@AssocationStorage</code> annotation (see <a class="xref" href="ogm-datastore-providers.html#ogm-couchdb-annotation-configuration" title="5.5.1.1. Annotation based configuration">Section 5.5.1.1, “Annotation based configuration”</a>),
the API for programmatic configuration (see <a class="xref" href="ogm-datastore-providers.html#ogm-couchdb-programmatic-configuration" title="5.5.1.2. Programmatic configuration">Section 5.5.1.2, “Programmatic configuration”</a>) or
specify a global default strategy via the <code class="literal">hibernate.ogm.datastore.document.association_storage</code> configuration property.</p><p>The possible strategies are <code class="literal">IN_ENTITY</code> (default) and <code class="literal">ASSOCIATION_DOCUMENT</code>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_in_entity_strategy_2"/>5.5.2.2.1. In Entity strategy</h5></div></div></div><p>With this strategy, Hibernate OGM directly stores the id(s)
of the other side of the association
into a field or an embedded document
depending if the mapping concerns a single object or a collection.
The field that stores the relationship information is named like the entity property.</p><div class="example"><a id="d0e3656"/><p class="title"><b>Example 5.36. Java entity</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">AccountOwner</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToMany</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">BankAccount</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bankAccounts</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;setters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span></pre></div></div><br class="example-break"/><div class="example"><a id="d0e3661"/><p class="title"><b>Example 5.37. JSON representation</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
    "_id": "AccountOwner:id_:owner0001_",
    "_rev": "1-d1cd3b00a677a2e31cd0480a796e8480",
    "$type": "entity",
    "$table": "AccountOwner",
    "bankAccounts" : [
        "accountABC",
        "accountXYZ"
    ]
}</pre></div></div><br class="example-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_association_document_strategy"/>5.5.2.2.2. Association document strategy</h5></div></div></div><p>With this strategy, Hibernate OGM uses separate association documents
(with <code class="literal">$type</code> set to "association") to store all navigation information.
Each assocation document is structured in 2 parts.
The first is the <code class="literal">_id</code> field which contains the identifier information
of the association owner and the name of the association table.
The second part is the <code class="literal">rows</code> field which stores (into an embedded collection) all ids
that the current instance is related to.</p><div class="example"><a id="d0e3680"/><p class="title"><b>Example 5.38. Unidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
   "_id": "AccountOwner_BankAccount:owners/_id_:4f5b48ad-f074-4a64-8cf4-1f9c54a33f76_",
   "_rev": "1-18ef25ec73c1942c45c868aa92f24f2c",
   "$type": "association",
   "rows": [
        7873a2a7-c77c-447c-b000-890f0a4dfa9a
   ]
}</pre></div></div><br class="example-break"/><p>For a bidirectional relationship, another document is created where ids are reversed.
Don’t worry, Hibernate OGM takes care of keeping them in sync:</p><div class="example"><a id="d0e3687"/><p class="title"><b>Example 5.39. Bidirectional relationship</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
   "_id": "AccountOwner_BankAccount:owners/_id_:4f5b48ad-f074-4a64-8cf4-1f9c54a33f76_",
   "_rev": "1-18ef25ec73c1942c45c868aa92f24f2c",
   "$type": "association",
   "rows": [
        "7873a2a7-c77c-447c-b000-890f0a4dfa9a"
   ]
}
{
   "_id": "AccountOwner_BankAccount:bankAccounts/_id_:7873a2a7-c77c-447c-b000-890f0a4dfa9a_",
   "_rev": "1-78e92f980745941a779abb914da65a6c",
   "$type": "association",
   "rows": [
        "4f5b48ad-f074-4a64-8cf4-1f9c54a33f76"
   ]
}</pre></div></div><br class="example-break"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_transactions_2"/>5.5.3. Transactions</h3></div></div></div><p>CouchDB does not support transactions.
Only changes applied to the same document are done atomically.
A change applied to more than one document will not be applied atomically.
This problem is slightly mitigated by the fact that Hibernate OGM queues all changes
before applying them during flush time.
So the window of time used to write to CouchDB is smaller than what you would have done manually.</p><p>We recommend that you still use transaction demarcations with Hibernate OGM
to trigger the flush operation transparently (on commit).
But do not consider rollback as a possibility, this won’t work.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_queries"/>5.5.4. Queries</h3></div></div></div><p>Hibernate OGM is a work in progress
and we are actively working on JP-QL query support.</p><p>In the mean time, you have two strategies to query entities stored by Hibernate OGM:</p><div class="itemizedlist"><ul><li>use native CouchDB queries</li><li>use Hibernate Search</li></ul></div><p>Because Hibernate OGM stores data in CouchDB in a natural way,
you can the HTTP client or REST library of your choice and execute queries (using CouchDB views)
on the datastore directly without involving Hibernate OGM.
The benefit of this approach is to use the query capabilities of CouchDB.
The drawback is that raw CouchDB documents will be returned and not managed entities.</p><p>The alternative approach is to index your entities with Hibernate Search.
That way, a set of secondary indexes independent of CouchDB is maintained by Hibernate Search
and you can write queries on top of them.
The benefit of this approach is an nice integration at the JPA / Hibernate API level
(managed entities are returned by the queries).
The drawback is that you need to store the Lucene indexes somewhere
(file system, infinispan grid etc).
Have a look at the Infinispan section for more info on how to use Hibernate Search.</p></div></div></div><HR xmlns=""/><a xmlns="" href=""/><ul class="docnav"><li class="previous"><a accesskey="p" href="ogm-configuration.html"><strong>Prev</strong>Chapter 4. Configure and start Hibernate OGM</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="ogm-mapping.html"><strong>Next</strong>Chapter 6. Map your entities</a></li></ul></body></html>